<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meditation App</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        .app {
            max-width: 600px;
            margin: auto;
        }
        .vid-container {
            position: relative;
            width: 100%;
        }
        video {
            width: 100%;
            border-radius: 10px;
        }
        .time-display {
            font-size: 2rem;
            margin: 20px 0;
        }
        .sound-picker, .time-select {
            margin: 10px;
        }
        button {
            padding: 10px 15px;
            font-size: 1rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="vid-container">
            <video id="video-player" src="Sounds/beach.mp4" loop></video>
        </div>
        <div class="time-display">10:0</div>
        <div class="time-select">
            <button id="smaller-mins">2 min</button>
            <button id="medium-mins">5 min</button>
            <button id="long-mins">10 min</button>
        </div>
        <div class="player-container">
            <audio id="audio-player" src="Sounds/beach.mp3"></audio>
        </div>
        <button class="play">Play</button>
        <div class="sound-picker">
            <button data-sound="Sounds/beach.mp3" data-video="Sounds/beach.mp4">Beach</button>
            <button data-sound="Sounds/rain.mp3" data-video="Sounds/rain.mp4">Rain</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const video = document.querySelector("#video-player");
            const audio = document.querySelector("#audio-player");
            const playBtn = document.querySelector(".play");
            const timeDisplay = document.querySelector(".time-display");
            const timeButtons = document.querySelectorAll(".time-select button");
            const soundButtons = document.querySelectorAll(".sound-picker button");

            let playing = false;
            let isAudioReady = false;
            let duration = 600; // Default to 10 minutes

            // Ensure Cypress waits for the audio to be ready
            audio.addEventListener("canplaythrough", () => {
                isAudioReady = true;
            });

            function updateTimerDisplay() {
                let minutes = Math.floor(duration / 60);
                let seconds = duration % 60;
                timeDisplay.textContent = `${minutes}:${seconds < 10 ? "0" + seconds : seconds}`;
            }

            function expectPlayingAudio(shouldBePlaying = true) {
                if (!isAudioReady) {
                    console.warn("Audio not ready yet.");
                    return false;
                }
                const isPlaying = !audio.paused && audio.currentTime > 0;
                return isPlaying === shouldBePlaying;
            }

            playBtn.addEventListener("click", () => {
                if (!playing) {
                    audio.play().catch(err => console.warn("Audio play error:", err));
                    video.play().catch(err => console.warn("Video play error:", err));
                    playing = true;
                } else {
                    audio.pause();
                    video.pause();
                    playing = false;
                }
            });

            timeButtons.forEach(button => {
                button.addEventListener("click", () => {
                    if (button.id === "smaller-mins") duration = 120;
                    else if (button.id === "medium-mins") duration = 300;
                    else if (button.id === "long-mins") duration = 600;
                    updateTimerDisplay();
                });
            });

            soundButtons.forEach(button => {
                button.addEventListener("click", () => {
                    let newSound = button.getAttribute("data-sound");
                    let newVideo = button.getAttribute("data-video");
                    audio.src = newSound;
                    video.src = newVideo;
                    if (playing) {
                        audio.play();
                        video.play();
                    }
                });
            });

            updateTimerDisplay();
            window.expectPlayingAudio = expectPlayingAudio; // For Cypress test compatibility
        });
    </script>
</body>
</html>
